---
layout: post
title: Verziószám megjelenítése az alkalmazásban
date: '2011-09-14T00:52:00.001+02:00'
author: István Viczián
tags:
- Maven
modified_time: '2011-09-14T00:54:43.384+02:00'
blogger_id: tag:blogger.com,1999:blog-7370998606556338092.post-6632348504802797991
blogger_orig_url: http://www.jtechlog.hu/2011/09/verzioszam-megjelenitese-az.html
---

<p>Technológiák: Maven 3.0.3, Build Number Maven Plugin 1.0</p>

<p>Kocka írt nem olyan régen egy <a href="http://iwillworkforfood.blogspot.com/2011/08/verzioszam.html">blog post</a>-jában arról, hogy hogyan lehet az alkalmazás verziószámát kiírni a felületre. Mivel én is nemrég csináltam meg több projektünkben is, álljon itt az én megoldásom.</p>

<p>Új projektjeink már Maven-t használnak build-eléshez, ahol a pom.xml tartalmazza a verziószámot. Én azt javaslom, hogy ez legyen is elég. Ez egyértelműen azonosít egy artifact-ot, azaz egy alkalmazást (vagy annak moduljait). Maven használata esetén a SNAPSHOT verziószámmal rendelkező artifact-ból lehet több is, de a release-elt artifact-ból csak egy lehet, ha egyszer kiadtuk, az már többet nem módosulhat. Javasolt tesztelésre, élesre csakis release-elt artifact-ot kitenni, így egyértelműen azonosítható, így elég lesz az azonosításra a verziószám is. Abban az esetben, ha mi SNAPSHOT verziókat is ki akarunk adni tesztelésre (amit nem javaslok), érdemes még valamilyen plusz azonosítót társítani a verziószám mellé. Ez lehet egy egyedileg kézzel megadott érték (ekkor elég nagy a hibalehetőség), egy automatikusan növelt egész szám (ennek a tárolásával lehetnek gondok), timestamp, vagy a legegyszerűbb esetben az SCM revision number. De ismétlem, erre csak akkor van szükség, ha snapshot-okat is kiadunk tesztelésre, és azokat akarjuk egyedileg azonosítani, ellenkező esetben elég a verziószám. A verziószámhoz tartozó információkat pedig lehetőleg az issue tracker tartalmazza. Ebből is látszik, hogy az SCM-et én egyszerű tárolónak tekintem, ott nem szeretek plusz meta információkat tárolni, vagy pl. a revision number-t venni bármi alapjául.</p>

<p>Amennyiben csak a release-elt alkalmazás verziószámát akarjuk kiírni, elegendő egy properties állományt létrehozni, és a Maven-t rávenni, hogy ebbe az állományba írja bele a verziószámot. Utána az alkalmazásba ezt a properties állományt kell becsomagolni, majd ezt beolvasni (pl. classpath-ról, getResourceAsStream-mel). Egy példa alkalmazás <a href="http://dl.dropbox.com/u/7683931/jtechlog/versioninfo.zip">letölthető</a>, mellyel ezt demonstrálom. Nem javaslom a MANIFEST.MF állomány piszkálását, mert ez csak akkor működik, ha a JAR be van csomagolva, ha pl. az alkalmazásszerver deploy-kor kicsomagolja az alkalmazást, akkor nem fog működni. A verziószám beírását a properties állományba a Maven a resoure-ok filter-elésével képes megoldani. Ekkor definiáljuk a következőt a pom.xml-ben: </p>

<pre class="brush: xml">
&lt;build&gt;
 &lt;resources&gt;
  &lt;resource&gt;
   &lt;directory&gt;src/main/resources&lt;/directory&gt;
   &lt;filtering&gt;true&lt;/filtering&gt;
  &lt;/resource&gt;
 &lt;/resources&gt;
&lt;/build&gt;
</pre>

<p>Valamint a properties állományban:</p>

<pre>
version=${project.version}
</pre>

<p>Ekkor látni fogjuk, hogy amikor a Maven átmásolja a properties állományt, kicseréli benne a ${project.version} szöveget a projekt verziószámára.</p>

<p>Amennyiben a MANIFEST.MF állományban is látni szeretnénk a verziószámot, a következővel egészítsük ki a pom.xml-t.</p>

<pre class="brush: xml">
&lt;plugin&gt;
 &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
 &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;
 &lt;version&gt;2.1&lt;/version&gt;
 &lt;configuration&gt;
  &lt;archive&gt;
   &lt;manifest&gt;
    &lt;addDefaultImplementationEntries&gt;true&lt;/addDefaultImplementationEntries&gt;
   &lt;/manifest&gt;
  &lt;/archive&gt;
 &lt;/configuration&gt;
&lt;/plugin&gt;
</pre>

<p>Ha mégis úgy döntünk, hogy szükségünk van build number-re is, mert SNAPSHOT verziót is azonosítani akarunk, akkor használhatjuk a <a href="http://mojo.codehaus.org/buildnumber-maven-plugin/">Build Number Maven Plugin</a>-t. Ennek két üzemmódja van. A build number-nek vagy az SCM revizióját használja, vagy megadhatunk neki egy formátumot. A formátumot a MessageFormat osztályban leírtaknak megfelelően lehet megadni. Itt behelyettesíthető egy vagy több egész szám, melye(ke)t automatikusan növel, a timestamp, valamint konstans értékek (szöveg és szám is).<p>

<p>Érdekes, hogy mindkét esetben definiálni kell az scm tag-et a pom.xml-ben, mert mindenképp lefuttat egy svn status parancsot, ahonnan ki tudja olvasni a branch nevét, amin éppen vagyunk. Ha nem adjuk meg az scm tag-et, a következő hibajelzést kapjuk:</p>

<p>Failed to execute goal org.codehaus.mojo:buildnumber-maven-plugin:1.0:create (default) on project versioninfo: Execution default of goal org.codehaus.mojo:buildnumber-maven-plugin:1.0:create failed: The scm url cannot be null. -> [Help 1]</p>

<p>Először nézzük, hogy mi történik, ha a build number-t a revision-ből akarjuk venni. Ehhez a következőt illesszük a pom.xml-be:</p>

<pre class="brush: xml">
&lt;plugin&gt;
 &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;
 &lt;artifactId&gt;buildnumber-maven-plugin&lt;/artifactId&gt;
 &lt;version&gt;1.0&lt;/version&gt;
 &lt;executions&gt;
  &lt;execution&gt;
   &lt;id&gt;buildNumber&lt;/id&gt;
   &lt;phase&gt;validate&lt;/phase&gt;
   &lt;goals&gt;
    &lt;goal&gt;create&lt;/goal&gt;
   &lt;/goals&gt;
   &lt;configuration&gt;
    &lt;doCheck&gt;true&lt;/doCheck&gt;
    &lt;doUpdate&gt;true&lt;/doUpdate&gt;
   &lt;/configuration&gt;
  &lt;/execution&gt;
 &lt;/executions&gt;
&lt;/plugin&gt;
</pre>

<p>Ekkor egyrészt lefuttat egy "svn status" parancsot, és ellenőrzi, hogy van-e módosított állomány. Majd egy "svn update" parancsot, és egy "svn info" parancsot. Ez alapján eltárolja a revision number-t a ${buildNumber} property-be, az aktuális timestamp-et a ${timestamp} property-be és a branch-et, amin vagyunk a ${scmBranch} property-be (ez lehet a trunk is). Ezeket a property-ket aztán a properties fájlba írva a Maven filter-eli.</p>

<p>Furcsa mód amennyiben a formátumos megadást is használni akarjuk, akkor azt nem tudjuk itt konfigurálni, hanem fel kell venni egy újabb execution tag-et.</p>

<pre class="brush: xml">
&lt;execution&gt;
 &lt;id&gt;buildInfo&lt;/id&gt;
 &lt;phase&gt;validate&lt;/phase&gt;
 &lt;goals&gt;
  &lt;goal&gt;create&lt;/goal&gt;
 &lt;/goals&gt;
 &lt;configuration&gt;
  &lt;buildNumberPropertyName&gt;buildInfo&lt;/buildNumberPropertyName&gt;
  &lt;format&gt;Incremental build number {0}.{1} 
at {2,time} on {2,date}, build on build server {3}{4}, env var: {5}.&lt;/format&gt;
  &lt;items&gt;
   &lt;item&gt;buildNumber0&lt;/item&gt;
   &lt;item&gt;buildNumber1&lt;/item&gt;
   &lt;item&gt;timestamp&lt;/item&gt;
   &lt;item&gt;jupiter&lt;/item&gt;
   &lt;item implementation=&quot;java.lang.Integer&quot;&gt;8&lt;/item&gt;
   &lt;item&gt;${envVar}&lt;/item&gt;
  &lt;/items&gt;
 &lt;/configuration&gt;
&lt;/execution&gt;
</pre>

<p>Látható, hogy hogyan lehet megadni a formátumot a format tag-ben, és ekkor meg kell adni az items tag-et is, felsorolva a behelyettesítendő értékeket. A buildNumber/d* (ami azt jelenti, hogy a buildNumber szó, megtoldva egy egész számmal) azt fogja eredményezni, hogy létrejön egy buildNumber.properties állomány (helye, neve konfigurálható), és ebben fogja tárolni az aktuális verziót, és build esetén megnöveli egyel. Az előző példában két ilyen verziószámot növelget, és jegyez be ebbe az állományba. A timestamp-et is ki lehet írni, méghozzá formázva (még érdekesebb formátum pl. {0,date,yyyy-MM-dd HH:mm:ss}), valamint konstansokat is meg lehet adni. Ebbe az a jó, hogy akár egy Maven property-t is, ahogy az ${envVar} property mutatja. Ekkor a build-et a "mvn -D envVar=CI install" paranccsal indítva a CI szót fogja a formátumba behelyettesíteni. Ez azért jó, mert akár a build szerveren, a CI (pl. Hudson/Jenkins) is be tudja ezt külön-külön állítani.</p>

<p>A fenti konfigurációval futtatva a build-et a következőt kapjuk:</p>

<p>Incremental build number 1.1 at 23:50:06 on 2011.09.13., build on build server jupiter8, env var: CI.</p>

<p>Ezt az értéket, ahogy a buildNumberPropertyName tag-ben láthatjuk, a ${buildInfo} property-be fogja eltenni (hogy ne üsse az előző ${buildNumber} proerty-t). Ezt a properties állományunkban a Maven megintcsak tudja filter-elni.</p>

<p>Amennyiben ezeket az értékeket a MANIFEST.MF-ben is szerepeltetni akarjuk, a következőt kell a pom-xml-be írni a maven-jar-plugin konfigurációjánál:</p>

<pre class="brush: xml">
&lt;archive&gt;
...
 &lt;manifestEntries&gt;
  &lt;Implementation-Build&gt;${buildNumber}&lt;/Implementation-Build&gt;
 &lt;/manifestEntries&gt;
...
&lt;/archive&gt;
</pre>